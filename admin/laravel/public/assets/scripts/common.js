$(document).ready(function() {

    /*
    //Use this with a meta tag for CSRF token
    //The folling line in your .blades
    <meta name="csrf-token" content="{{ csrf_token() }}">
    //And this code here
    $.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        }
    });
    */

    //Use this if passing CSRF token with every form as a hidden field generated by csrf_field()
    $.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': $('[name="_token"]').val()
        }
    });

    /*
     * Credentials Page buttons
     */

    $("#btn-newapikey_OFF").click(function(event) {
        //Make an AJAX call to the controller method to validate credentials
        $.ajax({
            type: 'POST',
            url: '/credentials/validate',
            data: {
                'remitter_id':$("#fld-remitterid").val(),
                'master_password':$("#fld-mstrpwd").val(),
                'api_key':$("#fld-apikey").val(),
            },
            dataType: 'json',
            success: function(response) {
                console.log(response);
                //On validattion success make another ajax call to generate the new key
                generateNewAPIKey();
            },
            error: function( xhr, status, error ) {
                console.log(xhr.responseText);
                var error_obj = JSON.parse(xhr.responseText);

                $("#div-errors").empty(); //clear any earlier errors
                $.each(error_obj, function(key,value){
                    $("#div-errors").append('<span class="list-group-item">'+value+'</span>');
                });
                console.log(error_obj['api_key']);
                $("#div-errors").show();
            }
        });
        event.preventDefault();
    });
         
    $("#btn-chngmstrpwd_OFF").click(function(event) {
        //Make an AJAX call to the controller method to validate credentials
        $.ajax({
            type: 'POST',
            url: '/credentials/validate',
            data: {
                'remitter_id':$("#fld-remitterid").val(),
                'master_password':$("#fld-mstrpwd").val(),
                'api_key':$("#fld-apikey").val(),
            },
            dataType: 'json',
            success: function(response) {
                console.log(response);
                //Get rid of the login fields so credentials are not viewable
                $("#pnl-entercredentials").html("");
                $("#pnl-chngmstrpwd").show();
            },
            error: function( xhr, status, error ) {
                console.log(xhr.responseText);
                var error_obj = JSON.parse(xhr.responseText);

                $("#div-errors").empty(); //clear any earlier errors
                $.each(error_obj, function(key,value){
                    $("#div-errors").append('<span class="list-group-item">'+value+'</span>');
                });
                console.log(error_obj['api_key']);
                $("#div-errors").show();
            }
        });
        event.preventDefault();
    });
         
    $("#btn-activatenewapikey").click(function(event) {
        //Make an AJAX call to the controller method to activate API Key
        $.ajax({
            type: 'POST',
            url: 'credentials/newapikey/activate',
            data: {},
            dataType: 'json',
            success: function(response) {
                console.log(response);
                $("#txt-newapikey").css("color","green");
                $("#lbl-newapikeymsg").text("Your new API key has been activated. Please ensure that all client applications, including batch jobs, are updated with the new API Key");
                $("#btn-activatenewapikey").hide();
                $("#btn-cancelnewapikey").hide();
            },
            error: function( xhr, status, error ) {
                console.log(xhr.responseText);
                var error_obj = JSON.parse(xhr.responseText);

                $("#div-errors").empty(); //clear any earlier errors
                $.each(error_obj, function(key,value){
                    $("#div-errors").append('<span class="list-group-item">'+value+'</span>');
                });
                console.log(error_obj['api_key']);
                $("#div-errors").show();
            }
        });
        event.preventDefault();
    });
         
    $(".changepartnerstatus").click(function(event) {
        //Decode the button clicked to toggle status
        if($(this).text() == "Activate")
            var status_to = 1;
        if($(this).text() == "Deactivate")
            var status_to = 0;
        //Make an AJAX call to the controller method to activate partner
        $.ajax({
            type: 'POST',
            url: '/partners/changeStatus',
            data: {
                    'partner_id':$(this).attr('id'),
                    'status_to':status_to,
            },
            dataType: 'json',
            success: function(response) {
                console.log(response);
                window.location.href = '/partners';
            },
            error: function( xhr, status, error ) {
                console.log(xhr.responseText);
                var error_obj = JSON.parse(xhr.responseText);

                $("#div-errors").empty(); //clear any earlier errors
                $.each(error_obj, function(key,value){
                    $("#div-errors").append('<span class="list-group-item">'+value+'</span>');
                });
                console.log(error_obj['api_key']);
                $("#div-errors").show();
            }
        });
        event.preventDefault();
    });
         
    $("#btn-confchngmstrpwd_OFF").click(function(event) {
        //Make an AJAX call to the controller method to activate API Key
        $.ajax({
            type: 'POST',
            url: 'credentials/newapikey/activate',
            data: {},
            dataType: 'json',
            success: function(response) {
                console.log(response);
                $("#lbl-newapikey").css("color","green");
                $("#lbl-newapikeymsg").text("Your new API key has been activated. Please ensure that all client applications, including batch jobs, are updated with the new API Key");
                $("#btn-activatenewapikey").hide();
                $("#btn-cancelnewapikey").hide();
            },
            error: function( xhr, status, error ) {
                console.log(xhr.responseText);
                var error_obj = JSON.parse(xhr.responseText);

                $("#div-errors").empty(); //clear any earlier errors
                $.each(error_obj, function(key,value){
                    $("#div-errors").append('<span class="list-group-item">'+value+'</span>');
                });
                console.log(error_obj['api_key']);
                $("#div-errors").show();
            }
        });
        event.preventDefault();
    });
         
    $("#btn-cancelnewapikey").click(function(event) {
        window.location.href = '/dashboard';
        event.preventDefault();
    });
         
    $("#btn-cnclchngmstrpwd").click(function(event) {
        window.location.href = '/dashboard';
        event.preventDefault();
    });

    //On focus for any input field, hide the error messages
    $( ":input" ).focus(function() {
          $("#div-errors").empty().hide();
    });
         
});

// Local functions
function generateUUID() {
    var d = new Date().getTime();
    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = (d + Math.random()*16)%16 | 0;
        d = Math.floor(d/16);
        return (c=='x' ? r : (r&0x3|0x8)).toString(16);
        });
    return uuid;
};

function generateNewAPIKey() {
    //Make an AJAX call to the controller method to generate new api key
        $.ajax({
            type: 'POST',
            url: 'credentials/newapikey',
            data: {
                'remitter_id':$("#fld-remitterid").val(),
                'master_password':$("#fld-mstrpwd").val(),
                'api_key':$("#fld-apikey").val(),
            },
            dataType: 'json',
            success: function(response) {
                console.log(response);
                $("#lbl-newapikey").text(response.payload.newapikey);
                $("#pnl-entercredentials").remove();
                $("#pnl-newapikey").show();
            },
            error: function( xhr, status, error ) {
                console.log(xhr.responseText);
                var error_obj = JSON.parse(xhr.responseText);

                $("#div-errors").empty(); //clear any earlier errors
                $.each(error_obj, function(key,value){
                    $("#div-errors").append('<span class="list-group-item">'+value+'</span>');
                });
                console.log(error_obj['api_key']);
                $("#div-errors").show();
            }
        });
}
